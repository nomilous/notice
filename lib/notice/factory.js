// Generated by CoffeeScript 1.4.0
var Message, NotifierFactory, asResolver, isMiddleWare, pipeline;

pipeline = require('when/pipeline');

Message = require('./message');

isMiddleWare = require('./decorators').isMiddleware;

asResolver = require('./decorators').asResolver;

module.exports = NotifierFactory = {
  create: function(config, callback) {
    var middleware, notifier,
      _this = this;
    config || (config = {});
    middleware = [];
    if (typeof config.messenger !== 'function') {
      throw new Error("" + this.constructor.name + " requires config.messenger");
    }
    notifier = function() {
      var fn, functions, message;
      message = new Message;
      message.label = arguments[0];
      message.description = arguments[1];
      if (!(middleware.length > 0)) {
        return config.messenger(message);
      }
      functions = [];
      return pipeline((function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = middleware.length; _i < _len; _i++) {
          fn = middleware[_i];
          functions.unshift(fn);
          _results.push(function() {
            return functions.pop()(message);
          });
        }
        return _results;
      })()).then(function() {
        return config.messenger(message);
      }, function(error) {
        return console.log("\nERROR IN MESSENGER MIDDLEWARE\n-----------------------------\n\n            um?\n\n   should probably protect \n         from this\n\n  MESSAGE WILL NOT BE SENT                                \n", error.stack, '\n');
      });
    };
    notifier.use = isMiddleWare(asResolver(function(fn) {
      return middleware.push(fn);
    }));
    return callback(null, notifier);
  }
};
