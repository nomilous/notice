// Generated by CoffeeScript 1.4.0
var Defer, Factory, Local, Message, asResolver, isMiddleWare, pipeline;

pipeline = require('when/pipeline');

Defer = require('when').defer;

Message = require('./message');

Local = require('./local');

isMiddleWare = require('./decorators').isMiddleware;

asResolver = require('./decorators').asResolver;

module.exports = Factory = {
  create: function(origin) {
    var after, middleware, notifier;
    if (typeof origin !== 'string') {
      throw new Error('Factory.create( origin ) require message origin as string');
    }
    middleware = [];
    after = [];
    if (Local()["default"] != null) {
      (isMiddleWare(asResolver(function(fn) {
        return after.push(fn);
      })))(Local()["default"]);
    }
    notifier = function(title, description, type, tenor) {
      var exit, fn, functions, message;
      message = new Message;
      exit = Defer();
      message.title = title;
      message.description = description;
      message.origin = origin;
      message.type = type;
      message.tenor = tenor;
      functions = [];
      return pipeline((function() {
        var _i, _len, _ref, _results;
        _ref = middleware.concat(after);
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          fn = _ref[_i];
          functions.push(fn);
          _results.push(function() {
            return functions.shift()(message);
          });
        }
        return _results;
      })()).then(function() {
        return exit.resolve(message);
      }, function() {
        return exit.reject.apply(null, arguments);
      }, function() {
        return exit.notify.apply(null, arguments);
      });
      return exit.promise;
    };
    return {
      use: isMiddleWare(asResolver(function(fn) {
        return middleware.push(fn);
      })),
      info: {
        good: function(title, description) {
          return notifier(title, description, 'info', 'good');
        },
        normal: function(title, description) {
          return notifier(title, description, 'info', 'normal');
        },
        bad: function(title, description) {
          return notifier(title, description, 'info', 'bad');
        }
      },
      event: {
        good: function(title, description) {
          return notifier(title, description, 'event', 'good');
        },
        normal: function(title, description) {
          return notifier(title, description, 'event', 'normal');
        },
        bad: function(title, description) {
          return notifier(title, description, 'event', 'bad');
        }
      }
    };
  }
};
