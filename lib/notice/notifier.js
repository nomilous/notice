// Generated by CoffeeScript 1.4.0
var Defer, Local, Message, Notifier, asResolver, isMiddleWare, pipeline;

pipeline = require('when/pipeline');

Defer = require('when').defer;

Message = require('./message');

Local = require('./local');

isMiddleWare = require('./decorators').isMiddleware;

asResolver = require('./decorators').asResolver;

module.exports = Notifier = {
  create: function(originName, defaultFn) {
    var after, afterCount, api, assigned, middleware, notifier;
    if (typeof originName !== 'string') {
      throw new Error('Notifier.create( originName ) requires message originName as string');
    }
    middleware = [];
    assigned = [];
    after = [];
    afterCount = void 0;
    if (Local()[originName] != null) {
      (isMiddleWare(asResolver(function(fn) {
        return assigned.push(fn);
      })))(Local()[originName]);
    } else if (defaultFn instanceof Function) {
      (isMiddleWare(asResolver(function(fn) {
        return assigned.push(fn);
      })))(defaultFn);
    } else {
      (isMiddleWare(asResolver(function(fn) {
        return assigned.push(fn);
      })))(function(msg, next) {
        return next();
      });
    }
    if (Local()["finally"] != null) {
      (isMiddleWare(asResolver(function(fn) {
        return after.push(fn);
      })))(Local()["finally"]);
    }
    afterCount = after.length;
    notifier = function(title, descriptionOr, type, tenor) {
      var Done, fn, functions, message;
      message = new Message(descriptionOr);
      Done = Defer();
      message.title = title;
      message.description = descriptionOr;
      message.origin = originName;
      message.type = type;
      message.tenor = tenor;
      functions = [];
      return pipeline((function() {
        var _i, _len, _ref, _results;
        _ref = middleware.concat(assigned).concat(after);
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          fn = _ref[_i];
          functions.push(fn);
          _results.push(function() {
            return functions.shift()(message);
          });
        }
        return _results;
      })()).then(function() {
        return Done.resolve(message);
      }, function() {
        return Done.reject.apply(null, arguments);
      }, function() {
        return Done.notify.apply(null, arguments);
      });
      return Done.promise;
    };
    api = function(title, description) {
      return notifier(title, description, 'info', 'normal');
    };
    api.use = isMiddleWare(asResolver(function(fn) {
      return middleware.push(fn);
    }));
    api.info = function(title, description) {
      return notifier(title, description, 'info', 'normal');
    };
    api.event = function(title, description) {
      return notifier(title, description, 'event', 'normal');
    };
    api.info.normal = api.info;
    api.info.good = function(title, description) {
      return notifier(title, description, 'info', 'good');
    };
    api.info.bad = function(title, description) {
      return notifier(title, description, 'info', 'bad');
    };
    api.event.normal = api.event;
    api.event.good = function(title, description) {
      return notifier(title, description, 'event', 'good');
    };
    api.event.bad = function(title, description) {
      return notifier(title, description, 'event', 'bad');
    };
    Object.defineProperty(api, 'finally', {
      set: isMiddleWare(asResolver(function(fn) {
        if (after.length > afterCount) {
          return;
        }
        return after[afterCount] = fn;
      }))
    });
    return api;
  }
};
