// Generated by CoffeeScript 1.6.3
var deferred, lifecycle, pipeline, testable, undefinedArg, v1, _ref,
  __slice = [].slice;

_ref = require('also'), pipeline = _ref.pipeline, deferred = _ref.deferred;

lifecycle = require('./capsule/lifecycle').lifecycle;

undefinedArg = require('./errors').undefinedArg;

v1 = require('node-uuid').v1;

testable = void 0;

module.exports._notifier = function() {
  return testable;
};

module.exports.notifier = function(config) {
  var api, local, type, _base;
  if (config == null) {
    config = {};
  }
  if (config.capsule == null) {
    config.capsule = {
      event: {}
    };
  }
  config.error || (config.error = {});
  if ((_base = config.error).keep == null) {
    _base.keep = 10;
  }
  config.capsule.control = {};
  testable = local = {
    capsuleTypes: {},
    notifiers: {},
    notifierMetrics: {},
    middleware: {},
    middlewareArray: {},
    middlewareMetrics: {},
    create: function(title, uuid) {
      var first, keepErrors, last, list, localErrors, localMetrics, middlewareCount, mwBus, mwMetrics, nfMetrics, notifier, reload, tooManyErrorsToKeep, traverse, type, _fn;
      if (uuid == null) {
        uuid = v1();
      }
      if (typeof title !== 'string') {
        throw new Error('Notifier.create(title) requires title as string');
      }
      if (local.middleware[title] != null) {
        throw new Error("Notifier.create('" + title + "') is already defined");
      }
      first = function(next) {
        return next();
        /* null*/

      };
      last = function(next) {
        return next();
        /* null*/

      };
      middlewareCount = 0;
      local.middleware[title] = list = {};
      local.middlewareArray[title] = mwBus = [];
      local.middlewareMetrics[title] = mwMetrics = {};
      local.notifierMetrics[title] = nfMetrics = {
        local: localMetrics = {
          input: {
            count: 0
          },
          processing: {
            count: 0
          },
          output: {
            count: 0
          },
          error: {
            usr: 0,
            sys: 0
          },
          cancel: {
            usr: 0,
            sys: 0
          }
        },
        errors: localErrors = {
          recent: []
        }
      };
      tooManyErrorsToKeep = function() {
        return localErrors.recent.length > config.error.keep;
      };
      keepErrors = function(title, type, error) {
        var _results;
        localErrors.recent.push({
          timestamp: new Date,
          error: error.toString(),
          middleware: {
            title: title,
            type: type
          }
        });
        _results = [];
        while (tooManyErrorsToKeep()) {
          _results.push(localErrors.recent.shift());
        }
        return _results;
      };
      traverse = function(capsule) {
        var cancelled, functions, middleware, traversal;
        traversal = {};
        cancelled = false;
        localMetrics.input.count++;
        localMetrics.processing.count++;
        functions = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = mwBus.length; _i < _len; _i++) {
            middleware = mwBus[_i];
            _results.push((function(middleware) {
              if (!middleware.enabled) {
                return (function() {});
              }
              return deferred(function(action) {
                var error, fn, next, notify, reject, resolve, type;
                resolve = action.resolve, reject = action.reject, notify = action.notify;
                type = middleware.type, title = middleware.title, fn = middleware.fn;
                next = function() {
                  return process.nextTick(function() {
                    return resolve(capsule);
                  });
                };
                next.notify = function(update) {
                  return process.nextTick(function() {
                    return notify(update);
                  });
                };
                next.reject = function(error) {
                  keepErrors(title, type, error);
                  localMetrics.processing.count--;
                  if (type === 'usr') {
                    localMetrics.error.usr++;
                  }
                  if (type === 'sys') {
                    localMetrics.error.sys++;
                  }
                  return process.nextTick(function() {
                    return reject(error);
                  });
                };
                next.cancel = function() {
                  cancelled = true;
                  localMetrics.processing.count--;
                  if (type === 'usr') {
                    localMetrics.cancel.usr++;
                  }
                  if (type === 'sys') {
                    localMetrics.cancel.sys++;
                  }
                  return process.nextTick(function() {
                    return notify({
                      _type: 'control',
                      control: 'cancel',
                      middleware: title,
                      capsule: capsule
                    });
                  });
                };
                try {
                  fn(next, capsule, traversal);
                  if (title === 'last' && !cancelled) {
                    localMetrics.output.count++;
                    return localMetrics.processing.count--;
                  }
                } catch (_error) {
                  error = _error;
                  keepErrors(title, type, error);
                  if (type === 'usr') {
                    localMetrics.error.usr++;
                  }
                  if (type === 'sys') {
                    localMetrics.error.sys++;
                  }
                  localMetrics.processing.count--;
                  return reject(error);
                }
              });
            })(middleware));
          }
          return _results;
        })();
        return pipeline(functions);
      };
      reload = function() {
        mwBus.length = 0;
        mwBus.push({
          type: 'sys',
          title: 'first',
          enabled: true,
          fn: first
        });
        for (title in list) {
          mwBus.push({
            type: 'usr',
            title: title,
            enabled: list[title].enabled,
            fn: list[title].fn
          });
        }
        mwBus.push({
          type: 'sys',
          title: 'last',
          enabled: true,
          fn: last
        });
        return middlewareCount = mwBus.length - 2;
      };
      reload();
      local.notifiers[title] = notifier = {
        got: function(title) {
          return list[title] != null;
        },
        use: function(opts, fn) {
          if (opts.enabled == null) {
            opts.enabled = true;
          }
          if (!((opts != null) && (opts.title != null) && (fn != null) && typeof fn === 'function')) {
            throw undefinedArg('opts.title and fn', 'use(opts, middlewareFn)');
          }
          if (!(opts.first || opts.last)) {
            if (opts.title === 'first' || opts.title === 'last') {
              process.stderr.write("notice: 'first' and 'last' are reserved middleware titles\n");
              return;
            }
          }
          if (opts.last != null) {
            if (typeof last === 'function' && !last.toString().match(/null/)) {
              process.stderr.write("notice: last middleware cannot be reset! Not even using the force()\n");
              return;
            }
            last = fn;
            reload();
            return;
          }
          if (opts.first != null) {
            if (typeof first === 'function' && !first.toString().match(/null/)) {
              process.stderr.write("notice: first middleware cannot be reset! Not even using the force()\n");
              return;
            }
            first = fn;
            reload();
            return;
          }
          if (list[opts.title] == null) {
            list[opts.title] = {
              title: opts.title,
              enabled: opts.enabled,
              fn: fn
            };
            reload();
            return;
          }
          return process.stderr.write("notice: middleware '" + opts.title + "' already exists, use the force()\n");
        },
        force: function(opts, fn) {
          if (!((opts != null) && (opts.title != null) && ((fn != null) && typeof fn === 'function') || ((opts["delete"] != null) && opts["delete"] === true) || ((opts.enabled != null) && typeof opts.enabled === 'boolean'))) {
            throw undefinedArg('opts.title and fn', 'use(opts, middlewareFn)');
          }
          if (opts["delete"] && (list[opts.title] != null)) {
            delete list[opts.title];
            reload();
            return;
          }
          if (opts.enabled != null) {
            list[opts.title].enabled = opts.enabled;
            if (opts.fn != null) {
              list[opts.title].fn = opts.fn;
            }
            reload();
            return;
          }
          if (opts.enabled == null) {
            opts.enabled = true;
          }
          list[opts.title] = {
            title: opts.title,
            enabled: opts.enabled,
            fn: fn
          };
          return reload();
        }
      };
      Object.defineProperty(notifier, 'uuid', {
        writable: false,
        enumerable: true,
        value: uuid
      });
      Object.defineProperty(notifier, 'title', {
        writable: false,
        enumerable: true,
        value: title
      });
      Object.defineProperty(notifier, 'serialize', {
        value: function(detail) {
          var middlewareTitle, middlewares, mmetics;
          if (detail == null) {
            detail = 1;
          }
          switch (detail) {
            case 1:
              return {
                title: notifier.title,
                uuid: notifier.uuid,
                metrics: {
                  local: nfMetrics.local
                }
              };
            case 2:
              middlewares = local.middleware[notifier.title];
              mmetics = local.middlewareMetrics[notifier.title];
              return {
                title: notifier.title,
                uuid: notifier.uuid,
                metrics: {
                  local: nfMetrics.local
                },
                errors: nfMetrics.errors,
                middlewares: (function() {
                  var _results;
                  _results = [];
                  for (middlewareTitle in middlewares) {
                    _results.push({
                      title: middlewareTitle,
                      enabled: middlewares[middlewareTitle].enabled,
                      metrics: mmetics
                    });
                  }
                  return _results;
                })()
              };
          }
        }
      });
      Object.defineProperty(notifier, 'raw', {
        get: function() {
          return function(payload) {
            return traverse(payload);
          };
        }
      });
      _fn = function(type) {
        return notifier[type] = deferred(function() {
          var arg, args, callback, key, notify, payload, reject, resolve, _i, _len, _ref1;
          args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          _ref1 = args.shift(), resolve = _ref1.resolve, reject = _ref1.reject, notify = _ref1.notify;
          payload = {};
          for (_i = 0, _len = args.length; _i < _len; _i++) {
            arg = args[_i];
            if ((typeof arg).match(/string|number/)) {
              if (payload[type] != null) {
                payload.description = arg;
              } else {
                payload[type] = arg;
              }
              continue;
            }
            if (arg instanceof Array) {
              continue;
            }
            for (key in arg) {
              if (key === type && (payload[key] != null)) {
                continue;
              }
              payload[key] = arg[key];
            }
          }
          if (typeof arg === 'function') {
            callback = arg;
          }
          return pipeline([
            function() {
              return local.capsuleTypes[type].create(payload);
            }, function(capsule) {
              return traverse(capsule);
            }
          ]).then(function(capsule) {
            resolve(capsule);
            if (callback != null) {
              return callback(null, capsule);
            }
          }, function(err) {
            reject(err);
            if (callback != null) {
              return callback(err);
            }
          }, notify);
        });
      };
      for (type in config.capsule) {
        if (notifier[type] != null) {
          continue;
        }
        _fn(type);
      }
      return notifier;
    }
  };
  for (type in config.capsule) {
    local.capsuleTypes[type] = lifecycle(type, config);
  }
  return api = {
    create: local.create
  };
};
