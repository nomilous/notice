// Generated by CoffeeScript 1.6.3
var deferred, message, pipeline, testable, undefinedArg, _ref,
  __slice = [].slice;

_ref = require('also'), pipeline = _ref.pipeline, deferred = _ref.deferred;

message = require('./capsule/message').message;

undefinedArg = require('./errors').undefinedArg;

testable = void 0;

module.exports._notifier = function() {
  return testable;
};

module.exports.notifier = function(config) {
  var api, local, type;
  if (config == null) {
    config = {};
  }
  if (config.capsules == null) {
    config.capsules = {
      event: {}
    };
  }
  config.capsules.control = {};
  testable = local = {
    capsuleTypes: {},
    middleware: {},
    notifiers: {},
    create: function(originCode) {
      var first, last, list, middlewareCount, notifier, traverse, type, _fn;
      if (typeof originCode !== 'string') {
        throw new Error('Notifier.create(originCode) requires originCode as string');
      }
      if (local.middleware[originCode] != null) {
        throw new Error("Notifier.create('" + originCode + "') is already defined");
      }
      middlewareCount = 0;
      local.middleware[originCode] = list = {};
      first = void 0;
      last = void 0;
      traverse = function(capsule) {
        var context, middleware, title;
        if (!(middlewareCount || (last != null))) {
          return capsule;
        }
        context = {};
        middleware = (function() {
          var _results;
          _results = [];
          for (title in list) {
            _results.push((function(title) {
              return deferred(function(_arg) {
                var error, next, notify, reject, resolve;
                resolve = _arg.resolve, reject = _arg.reject, notify = _arg.notify;
                next = function() {
                  return process.nextTick(function() {
                    return resolve(capsule);
                  });
                };
                next.info = function() {
                  return 'https://github.com/nomilous/notice/tree/develop/spec/notice#the-next-function';
                };
                next.notify = function(update) {
                  return process.nextTick(function() {
                    return notify(update);
                  });
                };
                next.reject = function(error) {
                  return process.nextTick(function() {
                    return reject(error);
                  });
                };
                next.cancel = function() {};
                try {
                  return list[title](next, capsule, context);
                } catch (_error) {
                  error = _error;
                  return reject(error);
                }
              });
            })(title));
          }
          return _results;
        })();
        if (last != null) {
          middleware.push(deferred(function(_arg) {
            var error, next, notify, reject, resolve;
            resolve = _arg.resolve, reject = _arg.reject, notify = _arg.notify;
            next = function() {
              return process.nextTick(function() {
                return resolve(capsule);
              });
            };
            next.notify = function(update) {
              return process.nextTick(function() {
                return notify(update);
              });
            };
            next.reject = function(error) {
              return process.nextTick(function() {
                return reject(error);
              });
            };
            next.cancel = function() {};
            try {
              return last(next, capsule, context);
            } catch (_error) {
              error = _error;
              return reject(error);
            }
          }));
        }
        if (first != null) {
          middleware.unshift(deferred(function(_arg) {
            var error, next, notify, reject, resolve;
            resolve = _arg.resolve, reject = _arg.reject, notify = _arg.notify;
            next = function() {
              return process.nextTick(function() {
                return resolve(capsule);
              });
            };
            next.notify = function(update) {
              return process.nextTick(function() {
                return notify(update);
              });
            };
            next.reject = function(error) {
              return process.nextTick(function() {
                return reject(error);
              });
            };
            next.cancel = function() {};
            try {
              return first(next, capsule, context);
            } catch (_error) {
              error = _error;
              return reject(error);
            }
          }));
        }
        return pipeline(middleware);
      };
      local.notifiers[originCode] = notifier = {
        use: function(opts, fn) {
          if (!((opts != null) && (opts.title != null) && (fn != null) && typeof fn === 'function')) {
            throw undefinedArg('opts.title and fn', 'use(opts, middlewareFn)');
          }
          if (opts.last != null) {
            if (typeof last === 'function') {
              process.stderr.write("notice: last middleware cannot be reset! Not even using the force()");
              return;
            }
            last = fn;
            return;
          }
          if (opts.first != null) {
            if (typeof first === 'function') {
              process.stderr.write("notice: first middleware cannot be reset! Not even using the force()");
              return;
            }
            first = fn;
            return;
          }
          if (list[opts.title] == null) {
            list[opts.title] = fn;
            middlewareCount++;
            return;
          }
          return process.stderr.write("notice: middleware '" + originCode + "' already exists, use the force()");
        },
        force: function(opts, fn) {
          if (!((opts != null) && (opts.title != null) && ((fn != null) && typeof fn === 'function') || ((opts["delete"] != null) && opts["delete"] === true))) {
            throw undefinedArg('opts.title and fn', 'use(opts, middlewareFn)');
          }
          if (opts["delete"] && (list[opts.title] != null)) {
            delete list[opts.title];
            middlewareCount++;
            return;
          }
          if (list[opts.title] == null) {
            middlewareCount++;
          }
          return list[opts.title] = fn;
        }
      };
      Object.defineProperty(notifier, 'raw', {
        get: function() {
          return function(payload) {
            return traverse(payload);
          };
        }
      });
      _fn = function(type) {
        return notifier[type] = deferred(function() {
          var arg, args, callback, key, notify, payload, reject, resolve, _i, _len, _ref1;
          args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          _ref1 = args.shift(), resolve = _ref1.resolve, reject = _ref1.reject, notify = _ref1.notify;
          payload = {};
          for (_i = 0, _len = args.length; _i < _len; _i++) {
            arg = args[_i];
            if ((typeof arg).match(/string|number/)) {
              if (payload[type] != null) {
                payload.description = arg;
              } else {
                payload[type] = arg;
              }
              continue;
            }
            if (arg instanceof Array) {
              continue;
            }
            for (key in arg) {
              if (key === type && (payload[key] != null)) {
                continue;
              }
              payload[key] = arg[key];
            }
          }
          if (typeof arg === 'function') {
            callback = arg;
          }
          return pipeline([
            function() {
              return local.capsuleTypes[type].create(payload);
            }, function(capsule) {
              return traverse(capsule);
            }
          ]).then(function(capsule) {
            resolve(capsule);
            if (callback != null) {
              return callback(null, capsule);
            }
          }, function(err) {
            reject(err);
            if (callback != null) {
              return callback(err);
            }
          }, notify);
        });
      };
      for (type in config.capsules) {
        if (notifier[type] != null) {
          continue;
        }
        _fn(type);
      }
      return notifier;
    }
  };
  for (type in config.capsules) {
    local.capsuleTypes[type] = message(type, config);
  }
  return api = {
    create: local.create
  };
};
