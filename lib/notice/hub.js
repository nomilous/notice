// Generated by CoffeeScript 1.4.0
var Notifier, listen;

listen = require('./listen');

Notifier = require('./notifier');

module.exports.create = function(hubName, opts, callback) {
  var createResponder, inbound, io, responders, _base;
  if (typeof hubName !== 'string') {
    throw new Error('Notifier.listen( hubName, opts ) requires hubName as string');
  }
  responders = {};
  createResponder = function(context, socket, callback) {
    var outbound;
    outbound = Notifier.create(hubName);
    outbound["finally"] = function(msg, next) {
      var type;
      type = msg.context.type;
      socket.emit(type, msg.context, msg);
      return next();
    };
    responders[socket.id] = {
      notice: outbound,
      context: context,
      connected: true
    };
    return callback();
  };
  opts || (opts = {});
  opts.listen || (opts.listen = {});
  (_base = opts.listen).secret || (_base.secret = '');
  opts.hub = {};
  inbound = Notifier.create(hubName);
  inbound.use(function(msg, next) {
    var responder;
    responder = responders[msg['socket.id']];
    msg.setResponder = responder.notice;
    delete msg['socket.id'];
    return next();
  });
  io = listen({
    loglevel: opts.listen.loglevel,
    address: opts.listen.address,
    port: opts.listen.port,
    cert: opts.listen.cert,
    key: opts.listen.key
  }, function(error, address) {
    opts.listening = address;
    if (typeof callback === 'function') {
      return callback(error, inbound);
    }
  });
  io.on('connection', function(socket) {
    var event, _fn, _i, _len, _ref;
    socket.on('handshake', function(secret, context) {
      if (secret === opts.listen.secret) {
        return createResponder(context, socket, function() {
          return socket.emit('accept');
        });
      } else {
        return socket.disconnect();
      }
    });
    _ref = ['info', 'event'];
    _fn = function(event) {
      return socket.on(event, function(context, msg) {
        var tenor, title;
        msg.direction = 'in';
        msg.origin = context.origin;
        title = context.title;
        tenor = context.tenor;
        msg['socket.id'] = socket.id;
        return inbound[event][tenor](title, msg);
      });
    };
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      event = _ref[_i];
      _fn(event);
    }
    return socket.on('disconnect', function() {});
  });
  return opts;
};
