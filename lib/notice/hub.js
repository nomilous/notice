// Generated by CoffeeScript 1.4.0
var listen;

listen = require('./listen');

module.exports.create = function(hubName, opts, callback) {
  var io;
  if (typeof hubName !== 'string') {
    throw new Error('Notifier.listen( hubName, opts ) requires hubName as string');
  }
  opts || (opts = {});
  opts.listen || (opts.listen = {});
  opts.hub = {
    socket: {},
    context: {}
  };
  io = listen({
    secret: opts.listen.secret,
    address: opts.listen.address,
    port: opts.listen.port,
    cert: opts.listen.cert,
    key: opts.listen.key
  }, function(error, address) {
    opts.hub.listening = address;
    if (typeof callback === 'function') {
      return callback(error, null);
    }
  });
  io.on('connection', function(socket) {
    socket.on('handshake', function(secret, context) {
      if (secret === opts.listen.secret) {
        opts.hub.socket[socket.id] = socket;
        opts.hub.context[socket.id] = context;
        return socket.emit('accept');
      } else {
        return socket.disconnect();
      }
    });
    return socket.on('disconnect', function() {});
  });
  return opts;
};
