// Generated by CoffeeScript 1.4.0
var connector, notifier, onConnected;

connector = require('./connector');

notifier = require('./notifier');

onConnected = function(title, opts, uplink, callback) {
  var notice;
  notice = notifier.create(title);
  notice.first = function(msg, next) {
    msg.direction = 'out';
    return next();
  };
  notice.last = function(msg, next) {
    var type;
    console.log('sending message:', JSON.stringify(msg.content, null, 2));
    type = msg.context.type;
    uplink.emit(type, msg.context, msg);
    return next();
  };
  return callback(null, notice);
};

module.exports = {
  connect: function(title, opts, callback) {
    return connector.connect({
      loglevel: opts.connect.loglevel,
      secret: opts.connect.secret,
      transport: opts.connect.transport,
      address: opts.connect.address,
      port: opts.connect.port
    }, function(error, uplink) {
      if (error != null) {
        return callback(error);
      }
      return onConnected(title, opts, uplink, callback);
    });
  }
};
