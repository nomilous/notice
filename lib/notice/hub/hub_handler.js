// Generated by CoffeeScript 1.6.3
var Testable, testable;

Testable = void 0;

testable = void 0;

module.exports._Handler = function() {
  return Testable;
};

module.exports._handler = function() {
  return testable;
};

module.exports.handler = function(config) {
  var Handler, api;
  if (config == null) {
    config = {};
  }
  Testable = Handler = {
    create: function(hubName, hubNotifier, hubContext, opts) {
      var handler;
      return testable = handler = {
        disconnect: function(socket) {
          return function() {
            var client, id;
            id = socket.id;
            try {
              client = hubContext.clients[id];
            } catch (_error) {}
            if (client == null) {
              return;
            }
            client.connected.state = 'disconnected';
            client.connected.stateAt = Date.now();
            return hubContext.connections();
          };
        },
        handshake: function(socket) {
          return function(originName, secret, context) {
            var previousID;
            if (secret !== opts.listen.secret) {
              return handler.reject(socket, {
                reason: 'bad secret'
              });
            }
            if (previousID = hubContext.name2id[originName]) {
              return handler.handleExisting(socket, previousID, originName, context);
            }
            return handler.handleNew(socket, originName, context);
          };
        },
        resume: function(socket) {
          return function(originName, secret, context) {
            var previousID;
            if (secret !== opts.listen.secret) {
              return handler.reject(socket, {
                reason: 'bad secret'
              });
            }
            if (previousID = hubContext.name2id[originName]) {
              return handler.handleExisting(socket, previousID, originName, context);
            }
            return handler.handleNew(socket, originName, context);
          };
        },
        accept: function(newSocket, existingClient, originName, newContext) {
          var id, key;
          id = newSocket.id;
          hubContext.clients[id] = existingClient;
          existingClient.connected || (existingClient.connected = {});
          existingClient.connected.state = 'connected';
          existingClient.connected.stateAt = Date.now();
          for (key in newContext) {
            existingClient.context[key] = newContext[key];
          }
          hubContext.name2id[originName] = id;
          newSocket.emit('accept');
          return hubContext.connections();
        },
        reject: function(socket, details) {
          socket.emit('reject', details);
          socket.disconnect();
        },
        handleNew: function(socket, originName, context) {
          var client;
          client = {
            title: originName,
            context: context,
            hub: hubName,
            socket: socket
          };
          return handler.accept(socket, client, originName, context);
        },
        handleExisting: function(newSocket, previousID, originName, newContext) {
          var client;
          client = hubContext.clients[previousID];
          if (client.connected.state === 'connected') {
            newSocket.emit('reject', {
              reason: 'already connected',
              hostname: client.context.hostname,
              pid: client.context.pid
            });
            newSocket.disconnect();
            hubContext.connections();
            return;
          }
          delete hubContext.clients[previousID];
          delete hubContext.name2id[originName];
          return handler.accept(newSocket, client, originName, newContext);
        }
      };
    }
  };
  return api = {
    create: Handler.create
  };
};
