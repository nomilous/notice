// Generated by CoffeeScript 1.6.3
var testable;

testable = void 0;

module.exports._handler = function() {
  return testable;
};

module.exports.handler = function(config) {
  var api, local;
  if (config == null) {
    config = {};
  }
  testable = local = {
    create: function(hubName, opts) {
      return {
        handshake: function(local, socket) {
          return function(originName, secret, context) {
            var client, id, previousID;
            id = socket.id;
            if (secret !== opts.listen.secret) {
              return socket.disconnect();
            }
            if (previousID = local.name2id[originName]) {
              client = local.clients[previousID];
              if (client.connected.state === 'connected') {
                socket.emit('reject', {
                  reason: 'already connected',
                  hostname: client.context.hostname,
                  pid: client.context.pid
                });
                socket.disconnect();
                local.connections();
                return;
              }
              delete local.clients[previousID];
              delete local.name2id[originName];
              local.clients[id] = client;
            } else {
              local.clients[socket.id] = client = {
                title: originName,
                context: context,
                hub: hubName,
                socket: socket
              };
            }
            client.connected || (client.connected = {});
            client.connected.state = 'connected';
            client.connected.stateAt = Date.now();
            client.context.hostname = context.hostname;
            client.context.pid = context.pid;
            local.name2id[originName] = id;
            socket.emit('accept');
            return local.connections();
          };
        },
        resume: function(local, socket) {
          return function(originName, secret, context) {
            var client, id, previousID;
            id = socket.id;
            if (secret !== opts.listen.secret) {
              return socket.disconnect();
            }
            if (previousID = local.name2id[originName]) {
              client = local.clients[previousID];
              delete local.clients[previousID];
              delete local.name2id[originName];
              local.clients[id] = client;
            } else {
              local.clients[socket.id] = client = {
                title: originName,
                context: context,
                hub: hubName
              };
            }
            client.connected || (client.connected = {});
            client.connected.state = 'connected';
            client.connected.stateAt = Date.now();
            client.context.hostname = context.hostname;
            client.context.pid = context.pid;
            local.name2id[originName] = id;
            socket.emit('accept');
            return local.connections();
          };
        },
        disconnect: function(local, socket) {
          return function() {
            var client, id;
            id = socket.id;
            try {
              client = local.clients[id];
            } catch (_error) {}
            if (client == null) {
              return;
            }
            client.connected.state = 'disconnected';
            client.connected.stateAt = Date.now();
            return local.connections();
          };
        }
      };
    }
  };
  return api = {
    create: local.create
  };
};
