// Generated by CoffeeScript 1.6.3
var authenticator, missingConfig, readFileSync, start, testable, version;

authenticator = require('./authenticator').authenticator;

missingConfig = require('../notice/errors').missingConfig;

start = require('../notice/hub/listener').start;

readFileSync = require('fs').readFileSync;

version = JSON.parse(readFileSync(__dirname + '/../../package.json', 'utf8')).version;

testable = void 0;

module.exports._manager = function() {
  return testable;
};

module.exports.manager = function(config) {
  var address, api, authenticated, listen, local, opts, port, server, transport, _ref;
  if (config == null) {
    config = {};
  }
  try {
    listen = config.manager.listen;
  } catch (_error) {}
  authenticated = authenticator(config);
  if (listen == null) {
    throw missingConfig('config.manager.listen', 'manager');
  }
  if (typeof listen.port !== 'number') {
    throw missingConfig('config.manager.listen.port', 'manager');
  }
  testable = local = {
    hubContext: void 0,
    register: function(hubContext) {
      return local.hubContext = hubContext;
    },
    methodNotAllowed: function(response) {
      response.writeHead(405);
      return response.end();
    },
    objectNotFound: function(response) {
      response.writeHead(404);
      return response.end();
    },
    respond: function(data, statusCode, response) {
      var body;
      body = JSON.stringify(data, null, 2);
      response.writeHead(statusCode, {
        'Content-Type': 'application/json',
        'Content-Length': body.length
      });
      response.write(body);
      return response.end();
    },
    routes: {
      '/about': {
        description: 'show this',
        methods: ['GET'],
        handler: function(matched, request, response, statusCode) {
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          return local.respond({
            module: 'notice',
            version: version,
            doc: 'https://github.com/nomilous/notice/tree/develop/spec/management',
            endpoints: local.routes
          }, statusCode, response);
        }
      },
      '/v1/hubs': {
        description: 'list present hubs',
        methods: ['GET'],
        handler: function(matched, request, response, statusCode) {
          var hubname, hubs;
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          hubs = {
            records: []
          };
          for (hubname in local.hubContext.hubs) {
            hubs.records.push({
              title: hubname,
              uuid: local.hubContext.hubs[hubname].uuid
            });
          }
          return local.respond(hubs, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:': {
        description: 'get a hub',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond({
            records: [notifier.serialize()]
          }, statusCode, response);
        }
      }
    }
  };
  port = listen.port;
  address = listen.hostname != null ? listen.hostname : '127.0.0.1';
  opts = {};
  opts.key = listen.key;
  opts.cert = listen.cert;
  _ref = start(opts, local.requestHandler = authenticated(function(request, response) {
    var error, match, matched, path, uuid, _ref;
    path = request.url;
    try {
      _ref = matched = path.match(/v1\/hubs\/(.*)/), match = _ref[0], uuid = _ref[1];
      if (!uuid.match(/\//)) {
        return local.routes['/v1/hubs/:uuid:'].handler([uuid], request, response);
      }
    } catch (_error) {
      error = _error;
    }
    if (local.routes[path] == null) {
      return local.routes['/about'].handler(null, request, response, 404);
    }
    return local.routes[path].handler(null, request, response);
  })), server = _ref.server, transport = _ref.transport;
  server.listen(port, address, function() {
    var _ref1;
    _ref1 = server.address(), address = _ref1.address, port = _ref1.port;
    return console.log('API @ %s://%s:%s', transport, address, port);
  });
  return api = {
    register: local.register
  };
};
