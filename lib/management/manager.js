// Generated by CoffeeScript 1.6.3
var Version, authenticator, coffee, missingConfig, readFileSync, start, testable;

authenticator = require('./authenticator').authenticator;

missingConfig = require('../notice/errors').missingConfig;

start = require('../notice/hub/listener').start;

readFileSync = require('fs').readFileSync;

coffee = require('coffee-script');

Version = JSON.parse(readFileSync(__dirname + '/../../package.json', 'utf8')).version;

testable = void 0;

module.exports._manager = function() {
  return testable;
};

module.exports.manager = function(config) {
  var address, api, authenticated, listen, local, opts, port, recursed, server, transport, _ref;
  if (config == null) {
    config = {};
  }
  try {
    listen = config.manager.listen;
  } catch (_error) {}
  authenticated = authenticator(config);
  if (listen == null) {
    throw missingConfig('config.manager.listen', 'manager');
  }
  if (typeof listen.port !== 'number') {
    throw missingConfig('config.manager.listen.port', 'manager');
  }
  recursed = function(type, resultHandler) {
    return function(_arg, request, response, statusCode) {
      var notifier, uuid;
      uuid = _arg[0];
      if (statusCode == null) {
        statusCode = 200;
      }
      if (request.method !== 'GET') {
        return local.methodNotAllowed(response);
      }
      if (!local.hubContext.uuids[uuid]) {
        return local.objectNotFound(response);
      }
      notifier = local.hubContext.uuids[uuid];
      return resultHandler(notifier.serialize(2)[type], request, response, statusCode);
    };
  };
  testable = local = {
    hubContext: void 0,
    register: function(hubContext) {
      return local.hubContext = hubContext;
    },
    methodNotAllowed: function(response) {
      response.writeHead(405);
      return response.end();
    },
    objectNotFound: function(response) {
      response.writeHead(404);
      return response.end();
    },
    unsupportedMedia: function(response) {
      response.writeHead(415);
      return response.end();
    },
    respond: function(data, statusCode, response) {
      var body;
      body = JSON.stringify(data, null, 2);
      response.writeHead(statusCode, {
        'Content-Type': 'application/json',
        'Content-Length': body.length
      });
      response.write(body);
      return response.end();
    },
    routes: {
      '/about': {
        description: 'show this',
        methods: ['GET'],
        handler: function(matched, request, response, statusCode) {
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          return local.respond({
            module: 'notice',
            version: Version,
            doc: 'https://github.com/nomilous/notice/tree/master/spec/management',
            endpoints: local.routes
          }, statusCode, response);
        }
      },
      '/v1/hubs': {
        description: 'list present hubs',
        methods: ['GET'],
        handler: function(matched, request, response, statusCode) {
          var data, hubname, notifier, uuid;
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          data = {
            records: []
          };
          for (hubname in local.hubContext.hubs) {
            uuid = local.hubContext.hubs[hubname].uuid;
            notifier = local.hubContext.uuids[uuid];
            data.records.push(notifier.serialize(1));
          }
          return local.respond(data, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:': {
        description: 'get a hub',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond(notifier.serialize(2), statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/metrics': {
        description: 'get only the metrics',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond(notifier.serialize(2).metrics, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/errors': {
        description: 'get only the recent errors',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond(notifier.serialize(2).errors, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/cache': {
        description: 'get output from a serailization of the traversal',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond(notifier.serialize(2).cache, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/tools': {
        description: 'get output from a serailization of the tools tree',
        methods: ['GET'],
        handler: recursed('tools', function(result, request, response, statusCode) {
          if (statusCode == null) {
            statusCode = 200;
          }
          return local.respond(result, statusCode, response);
        })
      },
      '/v1/hubs/:uuid:/cache/**/*': {
        description: 'get nested subkey from the cache tree',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var cache, deeper, notifier, uuid;
          uuid = _arg[0], deeper = _arg[1];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          cache = notifier.serialize(2).cache;
          deeper.split('/').map(function(key) {
            key = decodeURIComponent(key);
            return cache = cache[key];
          });
          return local.respond(cache, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/tools/**/*': {
        description: 'get nested subkey from the tools key',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var deeper, notifier, tools, uuid;
          uuid = _arg[0], deeper = _arg[1];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          tools = notifier.serialize(2).tools;
          deeper.split('/').map(function(key) {
            key = decodeURIComponent(key);
            console.log('\n', {
              notable: tools[key]
            }, '\n');
            return tools = tools[key];
          });
          return local.respond(tools, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/clients': {
        description: 'pending',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond(notifier.serialize(2).clients, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/middlewares': {
        description: 'get only the middlewares',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var notifier, uuid;
          uuid = _arg[0];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          notifier = local.hubContext.uuids[uuid];
          return local.respond(notifier.serialize(2).middlewares, statusCode, response);
        }
      },
      '/v1/hubs/:uuid:/middlewares/:title:': {
        description: 'get or update or delete a middleware',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var middlewares, notifier, title, uuid;
          uuid = _arg[0], title = _arg[1];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          title = decodeURIComponent(title);
          notifier = local.hubContext.uuids[uuid];
          middlewares = notifier.serialize(2).middlewares;
          try {
            return local.respond(middlewares[title], statusCode, response);
          } catch (_error) {}
          return objectNotFound(response);
        }
      },
      '/v1/hubs/:uuid:/middlewares/:title:/disable': {
        description: 'disable a middleware',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var middlewares, notifier, title, uuid;
          uuid = _arg[0], title = _arg[1];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          title = decodeURIComponent(title);
          notifier = local.hubContext.uuids[uuid];
          if (!notifier.got(title)) {
            return objectNotFound(response);
          }
          notifier.force({
            title: title,
            enabled: false
          });
          middlewares = notifier.serialize(2).middlewares;
          return local.respond(middlewares[title], statusCode, response);
          return objectNotFound(response);
        }
      },
      '/v1/hubs/:uuid:/middlewares/:title:/enable': {
        description: 'enable a middleware',
        methods: ['GET'],
        handler: function(_arg, request, response, statusCode) {
          var middlewares, notifier, title, uuid;
          uuid = _arg[0], title = _arg[1];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'GET') {
            return local.methodNotAllowed(response);
          }
          if (!local.hubContext.uuids[uuid]) {
            return local.objectNotFound(response);
          }
          title = decodeURIComponent(title);
          notifier = local.hubContext.uuids[uuid];
          if (!notifier.got(title)) {
            return objectNotFound(response);
          }
          notifier.force({
            title: title,
            enabled: true
          });
          middlewares = notifier.serialize(2).middlewares;
          return local.respond(middlewares[title], statusCode, response);
          return objectNotFound(response);
        }
      },
      '/v1/hubs/:uuid:/middlewares/:title:/replace': {
        description: 'replace a middleware',
        methods: ['POST'],
        accepts: ['text/javascript', 'text/coffee-script'],
        handler: function(_arg, request, response, statusCode) {
          var apply, body, notifier, title, uuid;
          uuid = _arg[0], title = _arg[1];
          if (statusCode == null) {
            statusCode = 200;
          }
          if (request.method !== 'POST') {
            return local.methodNotAllowed(response);
          }
          if (!(request.headers['content-type'] === 'text/javascript' || request.headers['content-type'] === 'text/coffee-script')) {
            return local.unsupportedMedia(response);
          }
          title = decodeURIComponent(title);
          notifier = local.hubContext.uuids[uuid];
          if (!notifier.got(title)) {
            return local.objectNotFound(response);
          }
          apply = function(fn) {
            if (typeof fn !== 'function') {
              return local.respond({
                error: (new Error('Requires middleware function')).toString()
              }, 400, response);
            }
            notifier.force({
              title: title
            }, fn);
            response.writeHead(200);
            return response.end();
          };
          body = '';
          request.on('data', function(buf) {
            return body += buf.toString();
          });
          return request.on('end', function() {
            var error, fn;
            if (request.headers['content-type'] === 'text/coffee-script') {
              try {
                body = coffee.compile(body, {
                  bare: true
                });
              } catch (_error) {
                error = _error;
                return local.respond({
                  error: error.toString()
                }, 400, response);
              }
            }
            try {
              fn = eval(body);
            } catch (_error) {
              error = _error;
              return local.respond({
                error: error.toString()
              }, 400, response);
            }
            return apply(fn);
          });
        }
      }
    }
  };
  port = listen.port;
  address = listen.hostname != null ? listen.hostname : '127.0.0.1';
  opts = {};
  opts.key = listen.key;
  opts.cert = listen.cert;
  _ref = start(opts, local.requestHandler = authenticated(function(request, response) {
    var action, base, deeper, match, nested, path, title, uuid, version, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6;
    path = request.url;
    if (path === '/about' || path === '/') {
      return local.routes["/about"].handler([], request, response);
    }
    if (path.slice(-1) === '/') {
      path = path.slice(0, -1);
    }
    try {
      _ref = path.match(/(.*)\/(.*)\/(.*)\/(.*)\/(.*)\/(.*)/), match = _ref[0], version = _ref[1], base = _ref[2], uuid = _ref[3], nested = _ref[4], title = _ref[5], action = _ref[6];
      return local.routes["" + version + "/" + base + "/:uuid:/" + nested + "/:title:/" + action].handler([uuid, title], request, response);
    } catch (_error) {}
    try {
      _ref1 = path.match(/(.*)\/(.*)\/(.*)\/(.*)\/(.*)/), match = _ref1[0], version = _ref1[1], base = _ref1[2], uuid = _ref1[3], nested = _ref1[4], title = _ref1[5];
      return local.routes["" + version + "/" + base + "/:uuid:/" + nested + "/:title:"].handler([uuid, title], request, response);
    } catch (_error) {}
    try {
      _ref2 = path.match(/(.*)\/(.*)\/(.*)\/(.*)/), match = _ref2[0], version = _ref2[1], base = _ref2[2], uuid = _ref2[3], nested = _ref2[4];
      try {
        if (_ref3 = path.match(/v1\/hubs\/(.*)\/cache\/(.*)/), match = _ref3[0], uuid = _ref3[1], deeper = _ref3[2], _ref3) {
          return local.routes["/v1/hubs/:uuid:/cache/**/*"].handler([uuid, deeper], request, response);
        }
      } catch (_error) {}
      try {
        if (_ref4 = path.match(/v1\/hubs\/(.*)\/tools\/(.*)/), match = _ref4[0], uuid = _ref4[1], deeper = _ref4[2], _ref4) {
          return local.routes["/v1/hubs/:uuid:/tools/**/*"].handler([uuid, deeper], request, response);
        }
      } catch (_error) {}
      return local.routes["" + version + "/" + base + "/:uuid:/" + nested].handler([uuid], request, response);
    } catch (_error) {}
    try {
      _ref5 = path.match(/(.*)\/(.*)\/(.*)/), match = _ref5[0], version = _ref5[1], base = _ref5[2], uuid = _ref5[3];
      return local.routes["" + version + "/" + base + "/:uuid:"].handler([uuid], request, response);
    } catch (_error) {}
    try {
      _ref6 = path.match(/(.*)\/(.*)/), match = _ref6[0], version = _ref6[1], base = _ref6[2];
      return local.routes["" + version + "/" + base].handler([], request, response);
    } catch (_error) {}
    return local.objectNotFound(response);
  })), server = _ref.server, transport = _ref.transport;
  server.listen(port, address, function() {
    var _ref1;
    _ref1 = server.address(), address = _ref1.address, port = _ref1.port;
    return console.log('API @ %s://%s:%s', transport, address, port);
  });
  return api = {
    register: local.register
  };
};
