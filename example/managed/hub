#! /usr/bin/env coffee

notice = require '../../lib/notice'

MessageHub = notice.hub
    
    error:
        keep: 2
    manager: 
        listen: 
            port: 44444
            cert: __dirname + '/../../cert/develop-cert.pem'
            key:  __dirname + '/../../cert/develop-key.pem'
        authenticate: 
            username: 'username'
            password: 'password'

MessageHub.create

    title: 'Purchases Processor'
    uuid:  1

    cache: {}

    listen: 
        adaptor: 'socket.io'
        port:    11111
        secret:  'secret'
        cert:    __dirname + '/../../cert/develop-cert.pem'
        key:     __dirname + '/../../cert/develop-key.pem'

    (error, hub) -> 

        return process.stdout.write error.toString() if error?

        hub.use 
            title: 'initialize'
            (next, capsule, traversal) ->

                {cache, origin} = traversal

                if capsule.control?
                    console.log capsule.control, origin.context.account
                    return next.cancel()

                return next() unless capsule.purchase?

                cache.purchases ||= 
                    largest: 
                        value: 0
                    smallest:
                        value: capsule.unit_price * capsule.quantity

                value = capsule.unit_price * capsule.quantity
                if value > cache.purchases.largest.value
                    cache.purchases.largest.value = value

                if value < cache.purchases.smallest.value
                    cache.purchases.smallest.value = value


                console.log 'initialize'
                next()

        hub.use 
            title: 'warehouse'
            (next, capsule, {cache}) -> 

                return next() unless capsule.purchase?
                console.log warehouse: capsule
                next()

        hub.use 
            title: 'accounts'
            (next, capsule, traversal) -> 

                return next() unless capsule.purchase?
                console.log accounts: capsule
                next()

        hub.use 
            title: 'despatch'
            (next, capsule, traversal) -> 

                return next() unless capsule.purchase?
                console.log despatch: capsule
                next()

        hub.use
            title: 'finalize', 
            (next, casule, traversal) -> 
                console.log 'finalize'
                console.log()
                next()


