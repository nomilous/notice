#!/usr/bin/env coffee

clients = {}
    
require('../lib/notice').listen 'Hub Name', 

    #
    # Configure with opts.listen
    # -------------------------- 
    # 
    #  * Using socket.io
    #  * PENDING: adaptor abstraction to enable transport plugins
    #

    listen:

        secret:   'â—Š'
        port:     10101
        address:  '0.0.0.0'
        cert:   __dirname + '/../cert/develop-cert.pem'
        key:    __dirname + '/../cert/develop-key.pem'


    #
    # Callback receives listening hub
    # -------------------------------
    # 
    # * hub is the interface to remote notifiers
    # * ... precise api design still in progress
    #

    (error, hub) -> 

        throw error if error?

        #
        # assign middleware to handle arriving messages
        #

        hub.use (msg, next) -> 

            console.log 'RECEIVED:', msg.context.origin, msg.event, msg

            pid = msg.pid

            unless responder = clients[pid]

                clients[pid] = responder = msg.context.responder

                                                #
                                                # keep this, it's for talking to 
                                                # the client
                                                #

            switch msg.event

                when 'connect', 'reconnect'

                    responder.use (msg, next) -> 

                        if msg.event == 'disconnect'

                            console.log 'disconnect from remote process at pid', pid

                        next()

                    if msg.event == 'reconnect'

                        responder.info 'thanks', thanks4: 'waiting'
                    
                
                    else 
                        responder.info 'greetings', hello: msg.context.origin

            next()
